<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–ç¶“å•ç­” RPGï¼šçœŸç†çš„è¦‹è­‰è€… (é›²ç«¯æ’è¡Œç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0f172a;
            color: white;
            overflow-y: auto; 
            overflow-x: hidden;
            touch-action: manipulation;
        }

        /* è¯éº—èƒŒæ™¯ */
        .bg-epic {
            background: radial-gradient(circle at center, #2e1065 0%, #0f172a 100%);
            min-height: 100vh;
        }
        
        /* ç»ç’ƒè³ªæ„Ÿ */
        .glass-panel {
            background: rgba(30, 41, 59, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .damage-text {
            position: absolute;
            font-weight: 900;
            font-size: 2.5rem;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
            animation: floatUp 1.2s forwards;
            pointer-events: none;
            z-index: 60; /* Higher than projectiles */
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            20% { transform: translateY(-20px) scale(1.3); opacity: 1; }
            100% { transform: translateY(-100px) scale(1); opacity: 0; }
        }

        .card-hover {
            transition: all 0.2s;
        }
        .card-hover:active {
            transform: scale(0.95);
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2); 
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }

        /* å…‰æšˆæ•ˆæœ */
        .glow-red {
            filter: drop-shadow(0 0 15px rgba(239, 68, 68, 0.6));
        }
        .glow-holy {
            filter: drop-shadow(0 0 10px rgba(250, 204, 21, 0.5));
        }
        .glow-blue {
            filter: drop-shadow(0 0 15px rgba(59, 130, 246, 0.5));
        }

        .fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .floating-icon {
            position: absolute;
            opacity: 0.2;
            animation: floatAnim 15s infinite linear;
            font-size: 3rem;
            user-select: none;
            pointer-events: none;
        }

        @keyframes floatAnim {
            0% { transform: translateY(110vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(-20vh) rotate(360deg); opacity: 0; }
        }

        .leaderboard-row:nth-child(1) .rank-num { color: #fbbf24; text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); font-size: 1.2em; }
        .leaderboard-row:nth-child(2) .rank-num { color: #9ca3af; text-shadow: 0 0 10px rgba(156, 163, 175, 0.5); font-size: 1.1em; }
        .leaderboard-row:nth-child(3) .rank-num { color: #b45309; text-shadow: 0 0 10px rgba(180, 83, 9, 0.5); font-size: 1.1em; }
        
        .status-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-online { background-color: #4ade80; box-shadow: 0 0 5px #4ade80; }
        .status-offline { background-color: #ef4444; box-shadow: 0 0 5px #ef4444; }

        /* Projectile Styles */
        .projectile {
            position: fixed; /* Fixed to move relative to viewport */
            font-size: 3rem;
            z-index: 55;
            pointer-events: none;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.8));
        }
    </style>
</head>
<body class="bg-epic flex flex-col lg:flex-row items-center justify-center p-4 gap-6">

    <!-- Container for the Game -->
    <div class="relative w-full max-w-lg h-[800px] max-h-[90vh] bg-gray-900 rounded-3xl shadow-2xl overflow-hidden border border-gray-700 shrink-0">

        <!-- Start Screen -->
        <div id="start-screen" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black bg-opacity-90 text-center p-4 overflow-hidden">
            <div class="absolute inset-0 z-0 overflow-hidden">
                <div class="floating-icon" style="left: 10%; animation-duration: 18s; animation-delay: 0s;">ğŸ</div>
                <div class="floating-icon" style="left: 25%; animation-duration: 22s; animation-delay: -5s;">ğŸ•¯ï¸</div>
                <div class="floating-icon" style="left: 40%; animation-duration: 15s; animation-delay: -2s;">ğŸ‡</div>
                <div class="floating-icon" style="left: 55%; animation-duration: 20s; animation-delay: -8s;">ğŸŒ¾</div>
                <div class="floating-icon" style="left: 70%; animation-duration: 25s; animation-delay: -3s;">ğŸº</div>
                <div class="floating-icon" style="left: 85%; animation-duration: 19s; animation-delay: -6s;">ğŸ </div>
                <div class="floating-icon" style="left: 15%; animation-duration: 23s; animation-delay: -10s;">ğŸ“–</div>
                <div class="floating-icon" style="left: 80%; animation-duration: 17s; animation-delay: -1s;">ğŸŸ</div>
            </div>

            <div class="relative z-10">
                <div class="mb-6 text-7xl glow-holy">ğŸ›¡ï¸âš”ï¸</div>
                <h1 class="text-5xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 via-yellow-100 to-yellow-300">è–ç¶“å•ç­” RPG<br><span class="text-2xl text-white font-normal tracking-widest">çœŸç†ä¹‹æˆ°</span></h1>
                <p class="text-blue-200 mb-8 max-w-md text-lg">100é“è–ç¶“é›£é¡Œï¼Œçµ•ä¸é‡è¤‡ï¼<br>ç©¿æˆ´å…¨å‰¯å±¬éˆè»è£ï¼Œéš¨è–éˆå¼•å°ï¼Œ<br>ç”¨çœŸç†æ“Šé€€é»‘æš—æ¬Šå‹¢ï¼</p>
                <button onclick="window.startGame()" class="px-10 py-4 bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-500 hover:to-blue-700 rounded-xl text-xl font-bold transition transform hover:scale-105 shadow-lg border border-blue-400">
                    é–‹å§‹å±¬éˆçˆ­æˆ°
                </button>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center bg-black bg-opacity-95 text-center p-4 overflow-hidden">
            <div id="game-over-bg" class="absolute inset-0 z-0 overflow-hidden pointer-events-none"></div>

            <div class="relative z-10 w-full max-w-sm">
                <div id="end-emoji" class="text-8xl mb-6 animate-bounce"></div>
                <h2 id="end-title" class="text-5xl font-bold mb-4"></h2>
                <p id="end-score" class="text-2xl text-yellow-400 mb-6 font-mono"></p>
                
                <!-- Score Submission Form -->
                <div class="bg-gray-800 bg-opacity-80 p-6 rounded-xl border border-gray-600 mb-6 shadow-xl backdrop-blur-sm">
                    <h3 class="text-lg font-bold text-gray-300 mb-3">ä¸Šå‚³æ¦®è€€æ¦œ</h3>
                    <input type="text" id="player-name-input" placeholder="è¼¸å…¥ä½ çš„åå­—" maxlength="10" 
                        class="w-full px-4 py-2 rounded bg-gray-900 border border-gray-600 text-white mb-3 focus:outline-none focus:border-yellow-400 text-center">
                    <button id="submit-score-btn" onclick="window.submitScore()" 
                        class="w-full py-2 bg-yellow-600 hover:bg-yellow-500 rounded font-bold text-white transition disabled:opacity-50 disabled:cursor-not-allowed">
                        ä¸Šå‚³åˆ†æ•¸
                    </button>
                    <p id="submit-msg" class="text-xs mt-2 min-h-[1rem] text-red-400"></p>
                </div>

                <button onclick="location.reload()" class="px-8 py-3 bg-gradient-to-r from-green-600 to-green-800 rounded-lg text-xl font-bold border border-green-400 shadow-lg hover:scale-105 transition">
                    é‡æ–°å¾—åŠ› (Play Again)
                </button>
            </div>
        </div>

        <!-- Main Game UI -->
        <div id="game-ui" class="w-full h-full flex flex-col relative hidden">
            <!-- Header -->
            <div class="glass-panel p-3 border-b border-gray-600 flex justify-between items-center shadow-lg z-10">
                <div class="text-yellow-400 font-bold text-xl drop-shadow-md">
                    Score: <span id="score-display">0</span>
                </div>
                <div class="text-cyan-300 font-bold text-sm bg-slate-800 px-4 py-1 rounded-full border border-cyan-700">
                    Chain: <span id="chain-display">0</span>
                </div>
                <div class="text-gray-300 text-sm font-bold">
                    BATTLE <span id="level-display" class="text-white text-lg">1</span>/7
                </div>
            </div>

            <!-- Battle Area -->
            <div class="flex-grow relative p-4">
                <div class="flex flex-col items-center mt-8 transition-all relative z-10" id="enemy-container">
                    <div class="w-full max-w-xs bg-gray-800 h-5 rounded-full overflow-hidden border-2 border-gray-600 mb-3 relative shadow-inner">
                        <div id="enemy-hp-bar" class="h-full bg-gradient-to-r from-red-600 to-red-500 transition-all duration-500 shadow-[0_0_10px_rgba(239,68,68,0.8)]" style="width: 100%;"></div>
                    </div>
                    <div class="text-6xl mb-2 glow-red animate-pulse transform hover:scale-110 transition duration-500 cursor-pointer" id="enemy-sprite">ğŸ‘¿</div>
                    <div class="text-2xl font-bold text-red-400 drop-shadow-md" id="enemy-name">æ‡·ç–‘ä¹‹éˆ</div>
                </div>

                <div id="effect-container" class="absolute inset-0 pointer-events-none z-50"></div>

                <!-- Player Section (Bottom Left) -->
                <div class="absolute bottom-2 left-4 z-20 flex flex-col items-center">
                    <div class="text-center relative mb-1">
                        <div class="text-5xl glow-holy animate-pulse" style="animation-duration: 3s;">ğŸ•Šï¸</div>
                        <div class="text-xs text-yellow-200 font-bold bg-black bg-opacity-50 px-2 rounded -mt-2 relative z-10 scale-75">è–éˆ</div>
                    </div>
                    <div class="text-center relative group">
                        <div id="skill-indicator" class="absolute -top-12 left-1/2 transform -translate-x-1/2 text-sm bg-yellow-500 text-white font-bold px-3 py-1 rounded-full shadow-lg opacity-0 transition border border-yellow-300 whitespace-nowrap z-30">è–éˆå……æ»¿!</div>
                        <div class="text-6xl glow-blue transition transform group-hover:-translate-y-1" id="player-sprite">ğŸ›¡ï¸âš”ï¸</div>
                        <div class="w-24 bg-gray-800 h-4 rounded-full overflow-hidden border border-gray-500 mt-1 relative shadow-lg mx-auto">
                            <div id="player-hp-bar" class="h-full bg-gradient-to-r from-green-500 to-emerald-400 transition-all duration-300 shadow-[0_0_10px_rgba(74,222,128,0.5)]" style="width: 100%;"></div>
                        </div>
                        <div class="text-[10px] text-white font-bold drop-shadow-md mt-0.5">HP <span id="hp-text">100</span></div>
                    </div>
                </div>
            </div>

            <!-- Card Selection -->
            <div id="card-selection-area" class="h-1/3 glass-panel p-4 border-t-2 border-gray-500 rounded-t-3xl shadow-[0_-5px_30px_rgba(0,0,0,0.6)] z-20 flex flex-col">
                <div class="text-center text-blue-200 mb-2 font-bold animate-bounce text-sm tracking-wider">â–¼ è«‹é¸æ“‡ä¸åŒå¼·åº¦çš„å±¬æ€§æ”»æ“Š â–¼</div>
                <div class="flex justify-around items-center h-full gap-3" id="cards-container"></div>
            </div>

            <!-- Question Modal -->
            <div id="question-modal" class="hidden absolute inset-0 z-40 bg-black bg-opacity-95 flex flex-col p-4 animate-fade-in backdrop-blur-sm">
                <div class="w-full bg-gray-800 h-3 mb-6 rounded-full overflow-hidden border border-gray-600">
                    <div id="timer-bar" class="h-full bg-gradient-to-r from-yellow-400 to-orange-500 w-full shadow-[0_0_10px_rgba(250,204,21,0.5)]"></div>
                </div>
                <div class="bg-slate-800 rounded-xl p-6 flex-grow flex flex-col shadow-2xl border border-slate-600 relative overflow-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <span id="q-category" class="px-4 py-1.5 rounded-full text-sm font-bold text-white shadow-md">æ„›å¿ƒ</span>
                        <span id="q-difficulty" class="text-sm text-gray-300 font-mono">é›£åº¦: å…¥é–€</span>
                    </div>
                    <h3 id="q-text" class="text-xl font-bold mb-4 leading-relaxed custom-scroll overflow-y-auto max-h-40 text-white drop-shadow-sm">å•é¡Œè¼‰å…¥ä¸­...</h3>
                    <div id="q-ref-container" class="hidden mb-4 p-2 bg-slate-900 bg-opacity-50 rounded border-l-4 border-yellow-500">
                        <p class="text-yellow-400 text-sm font-mono">ğŸ“– <span id="q-ref-text"></span></p>
                    </div>
                    <div class="grid grid-cols-1 gap-3 mt-auto" id="options-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Leaderboard Section -->
    <div class="w-full max-w-sm h-[600px] max-h-[80vh] bg-gray-900 rounded-3xl shadow-2xl overflow-hidden border border-gray-700 flex flex-col glass-panel shrink-0">
        <div class="bg-gradient-to-r from-yellow-700 to-yellow-900 p-4 text-center shadow-md flex justify-between items-center">
            <div>
                <h2 class="text-2xl font-bold text-yellow-100">ğŸ† æ¦®è€€æ’è¡Œæ¦œ</h2>
                <p class="text-xs text-yellow-200 opacity-80 text-left">Live Leaderboard</p>
            </div>
            <div class="text-xs font-bold px-2 py-1 bg-black bg-opacity-30 rounded flex items-center">
                <span id="conn-status-dot" class="status-dot status-offline"></span>
                <span id="conn-status-text">é€£ç·šä¸­...</span>
            </div>
        </div>
        <div class="flex-grow overflow-y-auto custom-scroll p-4">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="text-gray-400 border-b border-gray-700 text-sm">
                        <th class="py-2 pl-2">#</th>
                        <th class="py-2">è¦‹è­‰äºº</th>
                        <th class="py-2 text-right pr-2">åˆ†æ•¸</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body" class="text-sm">
                    <tr>
                        <td colspan="3" class="text-center py-4 text-gray-500">åˆå§‹åŒ–è³‡æ–™åº«...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Firebase Logic & Game Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // UI Helpers
        const setConnStatus = (online, msg) => {
            const dot = document.getElementById('conn-status-dot');
            const text = document.getElementById('conn-status-text');
            const submitBtn = document.getElementById('submit-score-btn');
            
            if (online) {
                if(dot) dot.className = "status-dot status-online";
                if(text) {
                    text.innerText = "å·²é€£ç·š";
                    text.className = "text-green-300";
                }
                // Automatically enable submit button if it was in waiting state
                if(submitBtn && submitBtn.disabled && submitBtn.innerText === "é€£ç·šä¸­...") {
                     submitBtn.disabled = false;
                     submitBtn.innerText = "ä¸Šå‚³åˆ†æ•¸";
                     submitBtn.className = "w-full py-2 bg-yellow-600 hover:bg-yellow-500 rounded font-bold text-white transition";
                }
            } else {
                if(dot) dot.className = "status-dot status-offline";
                if(text) {
                    text.innerText = msg || "é›¢ç·š";
                    text.className = "text-red-300";
                }
            }
        };

        // Configuration Fallback Logic
        let firebaseConfig;
        let APP_ID;

        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
                APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            } else {
                // FALLBACK for manual run / download
                firebaseConfig = {
                    apiKey: "AIzaSyC9fojZpT0TiSWSAtj525BLNwHQtIEePc0",
                    authDomain: "arpg-202601.firebaseapp.com",
                    projectId: "arpg-202601",
                    storageBucket: "arpg-202601.firebasestorage.app",
                    messagingSenderId: "64696139209",
                    appId: "1:64696139209:web:04ff78acbfec0da4d17c18"
                };
                APP_ID = "1:64696139209:web:04ff78acbfec0da4d17c18";
            }
        } catch (e) {
            console.warn("Config parsing failed, utilizing default fallback.");
        }

        // Initialize Services
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error:", e);
            setConnStatus(false, "è¨­å®šéŒ¯èª¤");
        }

        let currentUser = null;

        // --- Robust Auth Logic ---
        async function initAuth() {
            if (!auth) return;

            try {
                // Priority 1: Custom Token (Provided by Env)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("Attempting Token Login...");
                    const userCredential = await signInWithCustomToken(auth, __initial_auth_token);
                    currentUser = userCredential.user;
                    console.log("Token Login Success:", currentUser.uid);
                } else {
                    throw new Error("No token provided, falling back to Anon");
                }
            } catch (tokenError) {
                console.warn("Token Login Failed/Skipped:", tokenError.message);
                // Priority 2: Anonymous Login (Fallback)
                try {
                    console.log("Attempting Anonymous Login...");
                    const userCredential = await signInAnonymously(auth);
                    currentUser = userCredential.user;
                    console.log("Anon Login Success:", currentUser.uid);
                } catch (anonError) {
                    console.error("All Auth Methods Failed:", anonError);
                    setConnStatus(false, "é©—è­‰å¤±æ•—");
                    document.getElementById('leaderboard-body').innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-400">ç„¡æ³•é€£ç·šè‡³ä¼ºæœå™¨</td></tr>';
                    return; // Stop here
                }
            }

            // If we reached here, we are logged in
            setConnStatus(true);
            initLeaderboard();
        }
        
        initAuth();

        // --- Leaderboard Logic ---
        function initLeaderboard() {
            if (!currentUser || !db) return;

            try {
                // Rule: Use specific path as per instructions
                const scoresRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'scores');
                
                onSnapshot(scoresRef, (snapshot) => {
                    const scores = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.name && data.score !== undefined) {
                            scores.push(data);
                        }
                    });

                    // Sort descending & Slice top 10
                    scores.sort((a, b) => b.score - a.score);
                    const top10 = scores.slice(0, 10);
                    
                    renderLeaderboard(top10);
                }, (error) => {
                    console.error("Leaderboard Read Error:", error);
                    if (error.code === 'permission-denied') {
                        setConnStatus(false, "æ¬Šé™ä¸è¶³");
                    } else {
                        setConnStatus(false, "é€£ç·šä¸­æ–·");
                    }
                });
            } catch (e) {
                console.error("Init LB Error", e);
            }
        }

        function renderLeaderboard(data) {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">å°šç„¡ç´€éŒ„ï¼Œå¿«ä¾†æŒ‘æˆ°ï¼</td></tr>';
                return;
            }

            data.forEach((entry, index) => {
                const tr = document.createElement('tr');
                tr.className = "leaderboard-row border-b border-gray-800 hover:bg-white hover:bg-opacity-5 transition";
                
                let rankDisplay = index + 1;
                if(index === 0) rankDisplay = 'ğŸ¥‡';
                if(index === 1) rankDisplay = 'ğŸ¥ˆ';
                if(index === 2) rankDisplay = 'ğŸ¥‰';

                tr.innerHTML = `
                    <td class="py-3 pl-2 font-bold rank-num text-gray-400">${rankDisplay}</td>
                    <td class="py-3 text-white font-medium">${escapeHtml(entry.name)}</td>
                    <td class="py-3 text-right pr-2 text-yellow-400 font-mono font-bold">${entry.score}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        window.submitScore = async function() {
            const nameInput = document.getElementById('player-name-input');
            const submitBtn = document.getElementById('submit-score-btn');
            const msgEl = document.getElementById('submit-msg');
            const name = nameInput.value.trim();
            const score = state.score;

            msgEl.innerText = "";

            if (!name) {
                msgEl.innerText = "è«‹è¼¸å…¥åå­—ï¼";
                return;
            }

            if (!currentUser) {
                msgEl.innerText = "å°šæœªé€£ç·šï¼Œæ­£åœ¨å˜—è©¦é‡é€£...";
                // Try to reconnect
                await initAuth();
                if(!currentUser) {
                     msgEl.innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚";
                     return;
                }
            }

            try {
                submitBtn.disabled = true;
                submitBtn.innerText = "ä¸Šå‚³ä¸­...";

                const docData = {
                    name: name,
                    score: score,
                    uid: currentUser.uid,
                    timestamp: serverTimestamp()
                };

                await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'scores'), docData);

                submitBtn.innerText = "ä¸Šå‚³æˆåŠŸï¼";
                submitBtn.className = "w-full py-2 bg-green-600 rounded font-bold text-white transition cursor-default";
                nameInput.disabled = true;
                msgEl.innerText = "";
            } catch (error) {
                console.error("Submit Error: ", error);
                submitBtn.innerText = "ä¸Šå‚³å¤±æ•—";
                submitBtn.disabled = false;
                // Detailed error feedback
                if (error.code === 'permission-denied') {
                    msgEl.innerText = "æ¬Šé™ä¸è¶³ï¼šç„¡æ³•å¯«å…¥è³‡æ–™åº«";
                } else if (error.code === 'unavailable') {
                    msgEl.innerText = "é€£ç·šå•é¡Œï¼šç„¡æ³•é€£æ¥ Firestore";
                } else {
                    msgEl.innerText = `éŒ¯èª¤ï¼š${error.code || error.message}`;
                }
            }
        };

        // --- Game Logic ---
        const fullQuestionBank = [
            // Red (Jesus, Gospels, Love) ~30
            { q: "è€¶ç©Œåœ¨æ› é‡ç¦é£Ÿäº†å¤šå°‘å¤©ï¼Ÿ", options: ["3å¤©", "7å¤©", "40å¤©", "12å¤©"], a: 2, cat: "red", diff: 1, ref: "é¦¬å¤ªç¦éŸ³ 4:2" },
            { q: "è€¶ç©Œè¡Œçš„ç¬¬ä¸€å€‹ç¥è¹Ÿæ˜¯ä»€éº¼ï¼Ÿ", options: ["äº”é¤…äºŒé­š", "æ°´è®Šé…’", "å¹³éœé¢¨æµª", "é†«æ²»ççœ¼"], a: 1, cat: "red", diff: 1, ref: "ç´„ç¿°ç¦éŸ³ 2:1-11" },
            { q: "èª°åœ¨è€¶ç©Œè¢«è³£çš„é‚£ä¸€å¤œä¸‰æ¬¡ä¸èªä¸»ï¼Ÿ", options: ["å½¼å¾—", "ç´„ç¿°", "çŒ¶å¤§", "å¤šé¦¬"], a: 0, cat: "red", diff: 1, ref: "é¦¬å¤ªç¦éŸ³ 26:69-75" },
            { q: "ã€Œç¥æ„›ä¸–äººï¼Œç”šè‡³å°‡ä»–çš„ç¨ç”Ÿå­è³œçµ¦ä»–å€‘...ã€å‡ºè‡ªï¼Ÿ", options: ["é¦¬å¤ªç¦éŸ³", "é¦¬å¯ç¦éŸ³", "è·¯åŠ ç¦éŸ³", "ç´„ç¿°ç¦éŸ³"], a: 3, cat: "red", diff: 1, ref: "ç´„ç¿°ç¦éŸ³ 3:16" },
            { q: "è€¶ç©Œèªªï¼šã€Œæˆ‘å°±æ˜¯ç”Ÿå‘½çš„...ã€ï¼Ÿ", options: ["æ°´", "å…‰", "ç³§", "é–€"], a: 2, cat: "red", diff: 2, ref: "ç´„ç¿°ç¦éŸ³ 6:35" },
            { q: "å¥½æ’’é¦¬åˆ©äºäººçš„æ¯”å–»ä¸»è¦æ˜¯æ•™å°ä»€éº¼ï¼Ÿ", options: ["ä¿¡å¿ƒ", "æ„›é„°èˆ", "ç¦±å‘Š", "å¥‰ç»"], a: 1, cat: "red", diff: 1, ref: "è·¯åŠ ç¦éŸ³ 10:25-37" },
            { q: "è€¶ç©Œåœ¨å“ªè£¡è¢«é‡˜åå­—æ¶ï¼Ÿ", options: ["æ©„æ¬–å±±", "éŒ«å®‰å±±", "å„å„ä»–", "è¥¿å¥ˆå±±"], a: 2, cat: "red", diff: 1, ref: "é¦¬å¤ªç¦éŸ³ 27:33" },
            { q: "ç™»å±±å¯¶è¨“ä¸­ï¼Œè™›å¿ƒçš„äººæœ‰ç¦äº†ï¼Œå› ç‚ºï¼Ÿ", options: ["å¿…å¾—è¦‹ç¥", "å¤©åœ‹æ˜¯ä»–å€‘çš„", "å¿…å¾—å®‰æ…°", "å¿…æ‰¿å—åœ°åœŸ"], a: 1, cat: "red", diff: 3, ref: "é¦¬å¤ªç¦éŸ³ 5:3" },
            { q: "è€¶ç©Œå¾©æ´»å¾Œï¼Œæœ€å…ˆå‘èª°é¡¯ç¾ï¼Ÿ", options: ["å½¼å¾—", "æŠ¹å¤§æ‹‰çš„é¦¬åˆ©äº", "ç´„ç¿°", "å¤šé¦¬"], a: 1, cat: "red", diff: 2, ref: "é¦¬å¯ç¦éŸ³ 16:9" },
            { q: "è€¶ç©Œåœ¨åå­—æ¶ä¸Šèªªçš„æœ€å¾Œä¸€å¥è©±æ˜¯ï¼Ÿ", options: ["æˆäº†", "çˆ¶å•Šï¼Œèµ¦å…ä»–å€‘", "æˆ‘æ¸´äº†", "çˆ¶å•Šï¼æˆ‘å°‡æˆ‘çš„éˆé­‚äº¤åœ¨ä½ æ‰‹è£¡"], a: 3, cat: "red", diff: 3, ref: "è·¯åŠ ç¦éŸ³ 23:46" },
            { q: "å“ªä½é–€å¾’è¢«ç¨±ç‚ºã€Œé›·å­ã€ï¼Ÿ", options: ["é›…å„èˆ‡ç´„ç¿°", "å½¼å¾—èˆ‡å®‰å¾—çƒˆ", "è…“åŠ›èˆ‡å·´å¤šç¾…è²·", "é¦¬å¤ªèˆ‡å¤šé¦¬"], a: 0, cat: "red", diff: 3, ref: "é¦¬å¯ç¦éŸ³ 3:17" },
            { q: "è€¶ç©Œæ²»å¥½äº†å¹¾å€‹ç—²ç˜‹ç—…äººï¼Œåªæœ‰ä¸€å€‹å›ä¾†æ„Ÿæ©ï¼Ÿ", options: ["5å€‹", "7å€‹", "10å€‹", "12å€‹"], a: 2, cat: "red", diff: 2, ref: "è·¯åŠ ç¦éŸ³ 17:11-19" },
            { q: "é¦¬å¤ªç¦éŸ³è¨˜è¼‰ï¼Œè€¶ç©Œå®¶è­œçš„é–‹é ­æ˜¯èª°ï¼Ÿ", options: ["äºç•¶", "æŒªäº", "äºä¼¯æ‹‰ç½•", "å¤§è¡›"], a: 2, cat: "red", diff: 3, ref: "é¦¬å¤ªç¦éŸ³ 1:1" },
            { q: "è€¶ç©Œèªªé€™è©±æ˜¯èª°èªªçš„ï¼šã€Œä¸»å•Šï¼Œä½ æ´—æˆ‘çš„è…³å—ï¼Ÿã€", options: ["çŒ¶å¤§", "å½¼å¾—", "å¤šé¦¬", "è…“åŠ›"], a: 1, cat: "red", diff: 1, ref: "ç´„ç¿°ç¦éŸ³ 13:6" },
            { q: "æŒ‰æ‰å¹¹å—è²¬ä»»çš„æ¯”å–»ä¸­ï¼Œé ˜ä¸€åƒéŠ€å­çš„åƒ•äººåšäº†ä»€éº¼ï¼Ÿ", options: ["åšç”Ÿæ„è³ºäº†ä¸€åƒ", "æ”¾éŠ€è¡Œç”Ÿåˆ©æ¯", "æ˜åœ°åŸ‹è—", "åˆ†çµ¦çª®äºº"], a: 2, cat: "red", diff: 2, ref: "é¦¬å¤ªç¦éŸ³ 25:25" },
            { q: "è€¶ç©Œåœ¨å“ªå€‹æ± å­æ²»å¥½äº†38å¹´çš„ç™±å­ï¼Ÿ", options: ["è¥¿ç¾…äºæ± ", "ç•¢å£«å¤§æ± ", "é›…å„äº•", "ç´„æ—¦æ²³"], a: 1, cat: "red", diff: 3, ref: "ç´„ç¿°ç¦éŸ³ 5:2" },
            { q: "æµªå­å›é ­æ•…äº‹ä¸­ï¼Œçˆ¶è¦ªçµ¦å°å…’å­ç©¿ä¸Šä»€éº¼ï¼Ÿ", options: ["æ–°é‹", "è¢å­", "æˆ’æŒ‡", "ä»¥ä¸Šçš†æ˜¯"], a: 3, cat: "red", diff: 1, ref: "è·¯åŠ ç¦éŸ³ 15:22" },
            { q: "è€¶ç©Œå‘¼å¬é¦¬å¤ªæ™‚ï¼Œé¦¬å¤ªçš„è·æ¥­æ˜¯ï¼Ÿ", options: ["æ¼å¤«", "æœ¨åŒ ", "ç¨…å", "é†«ç”Ÿ"], a: 2, cat: "red", diff: 1, ref: "é¦¬å¤ªç¦éŸ³ 9:9" },
            { q: "èª°åœ¨å¤œè£¡ä¾†è¦‹è€¶ç©Œï¼Œå•é‡ç”Ÿçš„äº‹ï¼Ÿ", options: ["å°¼å“¥åº•æ¯", "è©²äºæ³•", "çš®æ‹‰å¤š", "ç´„ç‘Ÿ"], a: 0, cat: "red", diff: 2, ref: "ç´„ç¿°ç¦éŸ³ 3:1-2" },
            { q: "è€¶ç©Œèªªï¼šè®“å°å­©å­åˆ°æˆ‘é€™è£¡ä¾†ï¼Œå› ç‚ºåœ¨ç¥åœ‹çš„æ­£æ˜¯...ï¼Ÿ", options: ["è¬™å‘çš„äºº", "é€™æ¨£çš„äºº", "ç„¡ç½ªçš„äºº", "è²§çª®çš„äºº"], a: 1, cat: "red", diff: 2, ref: "é¦¬å¯ç¦éŸ³ 10:14" },
            { q: "è€¶ç©Œè¢«è–éˆå¼•åˆ°æ› é‡å—è©¦æ¢æ™‚ï¼Œå›ç­”é­”é¬¼çš„ç¬¬ä¸€å¥è©±å¼•ç”¨è‡ªï¼Ÿ", options: ["ç”³å‘½è¨˜", "è©©ç¯‡", "ä»¥è³½äºæ›¸", "å‡ºåŸƒåŠè¨˜"], a: 0, cat: "red", diff: 3, ref: "é¦¬å¤ªç¦éŸ³ 4:4 / ç”³å‘½è¨˜ 8:3" },
            { q: "è€¶ç©Œå¹³éœé¢¨æµªæ™‚ï¼Œé–€å¾’èªªäº†ä»€éº¼ï¼Ÿ", options: ["æ„Ÿè¬ä¸»", "é€™äººåˆ°åº•æ˜¯èª°", "æ•‘å‘½å•Š", "ç¥è¹Ÿå•Š"], a: 1, cat: "red", diff: 2, ref: "é¦¬å¯ç¦éŸ³ 4:41" },
            { q: "èª°ç‚ºäº†çœ‹è€¶ç©Œçˆ¬ä¸Šäº†æ¡‘æ¨¹ï¼Ÿ", options: ["æ’’è©²", "å·´åº•è²·", "æ‹‰æ’’è·¯", "é¦¬å¤ª"], a: 0, cat: "red", diff: 1, ref: "è·¯åŠ ç¦éŸ³ 19:1-4" },
            { q: "è€¶ç©Œèªªæœ€å¤§çš„èª¡å‘½æ˜¯ä»€éº¼ï¼Ÿ", options: ["ä¸å¯æ®ºäºº", "æ„›äººå¦‚å·±", "ç›¡å¿ƒæ„›ç¥", "ä¸å¯æ‹œå¶åƒ"], a: 2, cat: "red", diff: 2, ref: "é¦¬å¤ªç¦éŸ³ 22:37" },
            { q: "æ‹‰æ’’è·¯æ­»å¾Œå¹¾å¤©ï¼Œè€¶ç©Œä½¿ä»–å¾©æ´»ï¼Ÿ", options: ["1å¤©", "2å¤©", "3å¤©", "4å¤©"], a: 3, cat: "red", diff: 3, ref: "ç´„ç¿°ç¦éŸ³ 11:39" },
            { q: "é¦¬å¤§ç‚ºè€¶ç©Œå¿™ç¢Œï¼Œè€Œé¦¬åˆ©äºé¸æ“‡äº†ä»€éº¼ï¼Ÿ", options: ["å¹«å¿™åšé£¯", "æ‰“æƒæˆ¿å±‹", "ååœ¨è…³å‰è½é“", "å»è²·é¦™è†"], a: 2, cat: "red", diff: 1, ref: "è·¯åŠ ç¦éŸ³ 10:39" },
            { q: "èª°ç”¨é¦™è†æŠ¹ä¸»ï¼Œä¸¦ç”¨é ­é«®æ“¦ä¹¾ï¼Ÿ", options: ["é¦¬åˆ©äº", "é¦¬å¤§", "æ’’ç¾…ç±³", "ç´„äºæ‹¿"], a: 0, cat: "red", diff: 2, ref: "ç´„ç¿°ç¦éŸ³ 12:3" },
            { q: "è€¶ç©Œå·®é£å¤šå°‘é–€å¾’ï¼Œå…©å€‹å…©å€‹çš„å‡ºå»ï¼Ÿ", options: ["12å€‹", "70å€‹", "120å€‹", "500å€‹"], a: 1, cat: "red", diff: 3, ref: "è·¯åŠ ç¦éŸ³ 10:1" },
            { q: "èª°è¢«è¿«æ›¿è€¶ç©ŒèƒŒåå­—æ¶ï¼Ÿ", options: ["å·´æ‹‰å·´", "å¤åˆ©å¥ˆäººè¥¿é–€", "äºåˆ©é¦¬å¤ªç´„ç‘Ÿ", "å°¼å“¥åº•æ¯"], a: 1, cat: "red", diff: 2, ref: "é¦¬å¤ªç¦éŸ³ 27:32" },
            { q: "è€¶ç©Œå¾©æ´»å¾Œåœ¨ææ¯”å“©äºæµ·é‚Šç‚ºé–€å¾’æº–å‚™äº†ä»€éº¼ï¼Ÿ", options: ["é…’å’Œé¤…", "é­šå’Œé¤…", "ç¾Šè‚‰", "ç„¡èŠ±æœ"], a: 1, cat: "red", diff: 2, ref: "ç´„ç¿°ç¦éŸ³ 21:9" },

            // Blue (Prophecy, Wisdom, Revelation) ~30
            { q: "è–ç¶“ä¸­å“ªä¸€å·æ›¸è¢«ç¨±ç‚ºæ™ºæ…§ä¹‹æ›¸ï¼Ÿ", options: ["å‰µä¸–è¨˜", "ç®´è¨€", "å‡ºåŸƒåŠè¨˜", "åˆ©æœªè¨˜"], a: 1, cat: "blue", diff: 1, ref: "ç®´è¨€ 1:1-7" },
            { q: "ã€Œè€¶å’Œè¯æ˜¯æˆ‘çš„ç‰§è€…ï¼Œæˆ‘å¿…ä¸è‡´ç¼ºä¹ã€å‡ºè‡ªï¼Ÿ", options: ["è©©ç¯‡23ç¯‡", "è©©ç¯‡91ç¯‡", "è©©ç¯‡119ç¯‡", "è©©ç¯‡1ç¯‡"], a: 0, cat: "blue", diff: 1, ref: "è©©ç¯‡ 23:1" },
            { q: "å•Ÿç¤ºéŒ„çš„ä½œè€…æ˜¯èª°ï¼Ÿ", options: ["ä¿ç¾…", "å½¼å¾—", "ç´„ç¿°", "è·¯åŠ "], a: 2, cat: "blue", diff: 1, ref: "å•Ÿç¤ºéŒ„ 1:1" },
            { q: "ä»¥è³½äºé è¨€å½Œè³½äºå°‡ç”±èª°æ‡·å­•ç”Ÿå­ï¼Ÿ", options: ["è€å¹´å©¦äºº", "ç‹å", "ç«¥å¥³", "å¤–é‚¦å¥³å­"], a: 2, cat: "blue", diff: 1, ref: "ä»¥è³½äºæ›¸ 7:14" },
            { q: "å“ªä½å…ˆçŸ¥è¢«å¤§é­šåä¸‹ä¸‰å¤©ä¸‰å¤œï¼Ÿ", options: ["ä»¥åˆ©äº", "ç´„æ‹¿", "è€¶åˆ©ç±³", "ä½†ä»¥ç†"], a: 1, cat: "blue", diff: 1, ref: "ç´„æ‹¿æ›¸ 1:17" },
            { q: "å•Ÿç¤ºéŒ„ä¸­æåˆ°æ–°è€¶è·¯æ’’å†·åŸæœ‰å¹¾å€‹é–€ï¼Ÿ", options: ["7å€‹", "10å€‹", "12å€‹", "24å€‹"], a: 2, cat: "blue", diff: 2, ref: "å•Ÿç¤ºéŒ„ 21:12" },
            { q: "ã€Œæ•¬ç•è€¶å’Œè¯æ˜¯____çš„é–‹ç«¯ã€‚ã€", options: ["è²¡å¯Œ", "é•·å£½", "æ™ºæ…§", "æ¬ŠåŠ›"], a: 2, cat: "blue", diff: 1, ref: "ç®´è¨€ 9:10" },
            { q: "ä½†ä»¥ç†åœ¨ç…å­å‘ä¸­ç‚ºä½•æ²’æœ‰å—å‚·ï¼Ÿ", options: ["ç…å­ä¸é¤“", "ä»–æ®ºäº†ç…å­", "ç¥å°ä½ç…å­çš„å£", "åœ‹ç‹æ•‘äº†ä»–"], a: 2, cat: "blue", diff: 1, ref: "ä½†ä»¥ç†æ›¸ 6:22" },
            { q: "å‚³é“æ›¸èªªï¼šã€Œè™›ç©ºçš„è™›ç©ºï¼Œå‡¡äº‹éƒ½æ˜¯...ã€ï¼Ÿ", options: ["ç½ªæƒ¡", "ç—›è‹¦", "è™›ç©º", "ç¾å¥½"], a: 2, cat: "blue", diff: 2, ref: "å‚³é“æ›¸ 1:2" },
            { q: "å“ªä½å…ˆçŸ¥è¢«ç¨±ç‚ºã€Œæµæ·šçš„å…ˆçŸ¥ã€ï¼Ÿ", options: ["ä»¥è³½äº", "è€¶åˆ©ç±³", "ä»¥è¥¿çµ", "ä½•è¥¿é˜¿"], a: 1, cat: "blue", diff: 3, ref: "è€¶åˆ©ç±³æ›¸ 9:1" },
            { q: "ä»¥åˆ©äºä¹˜ä»€éº¼å‡å¤©ï¼Ÿ", options: ["é›²å½©", "æ—‹é¢¨", "ç«è»Šç«é¦¬", "å¤©ä½¿"], a: 1, cat: "blue", diff: 3, ref: "åˆ—ç‹ç´€ä¸‹ 2:11" },
            { q: "å•Ÿç¤ºéŒ„ä¸­ï¼Œè€¶ç©Œè¢«ç¨±ç‚ºçŒ¶å¤§æ”¯æ´¾çš„ä»€éº¼ï¼Ÿ", options: ["ç…å­", "ç¾”ç¾Š", "è€é·¹", "è‘¡è„æ¨¹"], a: 0, cat: "blue", diff: 3, ref: "å•Ÿç¤ºéŒ„ 5:5" },
            { q: "è©©ç¯‡ä¸­æœ€é•·çš„ä¸€ç¯‡æ˜¯ï¼Ÿ", options: ["117ç¯‡", "118ç¯‡", "119ç¯‡", "150ç¯‡"], a: 2, cat: "blue", diff: 3, ref: "è©©ç¯‡ 119" },
            { q: "æ‰€ç¾…é–€ç‹å‘ç¥æ±‚ä»€éº¼ï¼Ÿ", options: ["é•·å£½", "æ®ºæ•µ", "è²¡å¯Œ", "æ™ºæ…§"], a: 3, cat: "blue", diff: 1, ref: "åˆ—ç‹ç´€ä¸Š 3:9" },
            { q: "ç´„ä¼¯è¨˜ä¸­ï¼Œç´„ä¼¯çš„æœ‹å‹æœ‰å¹¾ä½ï¼ˆä¸»è¦å°è©±è€…ï¼‰ï¼Ÿ", options: ["2ä½", "3ä½", "4ä½", "5ä½"], a: 1, cat: "blue", diff: 3, ref: "ç´„ä¼¯è¨˜ 2:11" },
            { q: "é›…æ­Œæ›¸ä¸»è¦æå¯«ä»€éº¼é—œä¿‚ï¼Ÿ", options: ["è‰¯äººèˆ‡ä½³å¶", "çˆ¶æ¯èˆ‡å­å¥³", "æœ‹å‹", "å›ç‹èˆ‡è‡£æ°‘"], a: 0, cat: "blue", diff: 2, ref: "é›…æ­Œ" },
            { q: "å“ªå·æ›¸æåˆ°ã€Œæ¯éª¨å¾©ç”Ÿã€çš„ç•°è±¡ï¼Ÿ", options: ["ä»¥è³½äºæ›¸", "è€¶åˆ©ç±³æ›¸", "ä»¥è¥¿çµæ›¸", "ä½†ä»¥ç†æ›¸"], a: 2, cat: "blue", diff: 3, ref: "ä»¥è¥¿çµæ›¸ 37:1-14" },
            { q: "ã€Œä½ çš„è©±æ˜¯æˆ‘è…³å‰çš„ç‡ˆï¼Œæ˜¯æˆ‘è·¯ä¸Šçš„å…‰ã€å‡ºè‡ªï¼Ÿ", options: ["ç®´è¨€", "è©©ç¯‡", "ç´„ç¿°ç¦éŸ³", "ä»¥è³½äºæ›¸"], a: 1, cat: "blue", diff: 1, ref: "è©©ç¯‡ 119:105" },
            { q: "èª°å¨¶äº†æ·«å©¦æ­Œè”‘ç‚ºå¦»ï¼Œè±¡å¾µç¥æ„›èƒŒé“çš„ä»¥è‰²åˆ—ï¼Ÿ", options: ["é˜¿æ‘©å¸", "ä½•è¥¿é˜¿", "ç´„ç¥", "å½Œè¿¦"], a: 1, cat: "blue", diff: 3, ref: "ä½•è¥¿é˜¿æ›¸ 1:2" },
            { q: "ä½†ä»¥ç†çš„ä¸‰å€‹æœ‹å‹è¢«æ‰”é€²ä»€éº¼åœ°æ–¹ï¼Ÿ", options: ["ç…å­å‘", "ç«çª¯", "æ·±æ·µ", "ç›£ç„"], a: 1, cat: "blue", diff: 2, ref: "ä½†ä»¥ç†æ›¸ 3:20" },
            { q: "ã€Œæ—¥å­å°‡åˆ°ï¼Œæˆ‘å¿…å°‡æˆ‘çš„éˆæ¾†çŒå‡¡æœ‰è¡€æ°£çš„...ã€æ˜¯å“ªä½å…ˆçŸ¥èªªçš„ï¼Ÿ", options: ["ç´„ç¥", "ä»¥è³½äº", "è€¶åˆ©ç±³", "ç‘ªæ‹‰åŸº"], a: 0, cat: "blue", diff: 3, ref: "ç´„ç¥æ›¸ 2:28" },
            { q: "å•Ÿç¤ºéŒ„ä¸­æåˆ°ã€Œå¤§æ·«å©¦ã€æ˜¯æŒ‡ï¼Ÿ", options: ["è€¶æ´—åˆ¥", "å·´æ¯”å€«å¤§åŸ", "æ¨ç¾…", "å°¼å°¼å¾®"], a: 1, cat: "blue", diff: 3, ref: "å•Ÿç¤ºéŒ„ 17:5" },
            { q: "èª°çœ‹è¦‹ã€Œä¸»ååœ¨é«˜é«˜çš„å¯¶åº§ä¸Šï¼Œè¡£è£³å‚ä¸‹ï¼Œé®æ»¿è–æ®¿ã€ï¼Ÿ", options: ["ä»¥è³½äº", "ä»¥è¥¿çµ", "ä½†ä»¥ç†", "æ‘©è¥¿"], a: 0, cat: "blue", diff: 3, ref: "ä»¥è³½äºæ›¸ 6:1" },
            { q: "ã€Œè¡Œå…¬ç¾©ï¼Œå¥½æ†æ†«ï¼Œå­˜è¬™å‘çš„å¿ƒèˆ‡ç¥åŒè¡Œã€å‡ºè‡ªï¼Ÿ", options: ["å½Œè¿¦æ›¸", "é˜¿æ‘©å¸æ›¸", "å“ˆå·´è°·æ›¸", "è¥¿ç•ªé›…æ›¸"], a: 0, cat: "blue", diff: 3, ref: "å½Œè¿¦æ›¸ 6:8" },
            { q: "ç®´è¨€ä¸­èªªï¼Œæ‰å¾·çš„å©¦äººåƒ¹å€¼é å‹éä»€éº¼ï¼Ÿ", options: ["é»ƒé‡‘", "çç ", "å¯¶çŸ³", "ç™½éŠ€"], a: 1, cat: "blue", diff: 2, ref: "ç®´è¨€ 31:10" },
            { q: "è©©ç¯‡23ç¯‡èªªï¼šä»–ä½¿æˆ‘èººè‡¥åœ¨...ï¼Ÿ", options: ["æºªæ°´æ—", "é’è‰åœ°ä¸Š", "å¹½è°·ä¸­", "ç›¤çŸ³ä¸Š"], a: 1, cat: "blue", diff: 1, ref: "è©©ç¯‡ 23:2" },
            { q: "å“ªä¸€å·æ›¸åªæœ‰ä¸€ç« ï¼Ÿ", options: ["ä¿„å·´åº•äºæ›¸", "ç´„æ‹¿æ›¸", "å“ˆè©²æ›¸", "é‚£é´»æ›¸"], a: 0, cat: "blue", diff: 3, ref: "ä¿„å·´åº•äºæ›¸" },
            { q: "èª°ç‚ºè€¶è·¯æ’’å†·åŸç‰†è¢«æ¯€è€Œå“­æ³£ç¦é£Ÿï¼Ÿ", options: ["ä»¥æ–¯æ‹‰", "å°¼å¸Œç±³", "ä»¥æ–¯å¸–", "æ‰€ç¾…é–€"], a: 1, cat: "blue", diff: 2, ref: "å°¼å¸Œç±³è¨˜ 1:4" },
            { q: "å•Ÿç¤ºéŒ„ä¸­ï¼Œæ˜äº®çš„æ™¨æ˜Ÿæ˜¯æŒ‡èª°ï¼Ÿ", options: ["è·¯è¥¿æ³•", "è€¶ç©Œ", "å¤§è¡›", "å¤©ä½¿é•·"], a: 1, cat: "blue", diff: 2, ref: "å•Ÿç¤ºéŒ„ 22:16" },
            { q: "ã€Œè‰å¿…æ¯ä¹¾ï¼ŒèŠ±å¿…å‡‹æ®˜ï¼ŒæƒŸæœ‰æˆ‘å€‘ç¥çš„è©±å¿…æ°¸é ç«‹å®šã€å‡ºè‡ªï¼Ÿ", options: ["ä»¥è³½äºæ›¸", "è€¶åˆ©ç±³æ›¸", "è©©ç¯‡", "å½¼å¾—å‰æ›¸"], a: 0, cat: "blue", diff: 2, ref: "ä»¥è³½äºæ›¸ 40:8" },

            // Yellow (History, Law, Acts) ~30
            { q: "èª°å¸¶é ˜ä»¥è‰²åˆ—äººå‡ºåŸƒåŠï¼Ÿ", options: ["äºä¼¯æ‹‰ç½•", "æ‘©è¥¿", "ç´„æ›¸äº", "å¤§è¡›"], a: 1, cat: "yellow", diff: 1, ref: "å‡ºåŸƒåŠè¨˜ 3:10" },
            { q: "äººé¡æ­·å²ä¸Šç¬¬ä¸€æ¨è¬€æ®ºæ¡ˆçš„å…‡æ‰‹æ˜¯ï¼Ÿ", options: ["äºç•¶", "è©²éš±", "äºä¼¯", "æ‹‰éº¥"], a: 1, cat: "yellow", diff: 1, ref: "å‰µä¸–è¨˜ 4:8" },
            { q: "å¤§è¡›ç”¨ä»€éº¼æ‰“æ•—äº†å·¨äººæ­Œåˆ©äºï¼Ÿ", options: ["åŠ", "é•·æ§", "æ©Ÿå¼¦ç”©çŸ³", "å¼“ç®­"], a: 2, cat: "yellow", diff: 1, ref: "æ’’æ¯è€³è¨˜ä¸Š 17:49" },
            { q: "æŒªäºæ–¹èˆŸæœ€å¾Œåœåœ¨å“ªè£¡ï¼Ÿ", options: ["è¥¿å¥ˆå±±", "äºæ‹‰è‡˜å±±", "æ©„æ¬–å±±", "è¿¦å¯†å±±"], a: 1, cat: "yellow", diff: 2, ref: "å‰µä¸–è¨˜ 8:4" },
            { q: "ä½¿å¾’è¡Œå‚³ä¸­ï¼Œè–éˆåœ¨ä»€éº¼æ—¥å­é™è‡¨ï¼Ÿ", options: ["é€¾è¶Šç¯€", "ä½æ£šç¯€", "äº”æ—¬ç¯€", "æ™®ç¥ç¯€"], a: 2, cat: "yellow", diff: 2, ref: "ä½¿å¾’è¡Œå‚³ 2:1" },
            { q: "ä¿ç¾…åœ¨å»å“ªè£¡çš„è·¯ä¸Šçœ‹è¦‹å¤§å…‰ä¸¦æ‚”æ”¹ï¼Ÿ", options: ["è€¶è·¯æ’’å†·", "å®‰æé˜¿", "ç¾…é¦¬", "å¤§é¦¬å£«é©"], a: 3, cat: "yellow", diff: 1, ref: "ä½¿å¾’è¡Œå‚³ 9:3" },
            { q: "èª°è¢«ç¨±ç‚ºã€Œä¿¡å¿ƒä¹‹çˆ¶ã€ï¼Ÿ", options: ["äºä¼¯æ‹‰ç½•", "ä»¥æ’’", "é›…å„", "ç´„ç‘Ÿ"], a: 0, cat: "yellow", diff: 1, ref: "ç¾…é¦¬æ›¸ 4:11" },
            { q: "ä»¥è‰²åˆ—ç¬¬ä¸€ä½åœ‹ç‹æ˜¯èª°ï¼Ÿ", options: ["å¤§è¡›", "æƒç¾…", "æ‰€ç¾…é–€", "æ’’æ¯è€³"], a: 1, cat: "yellow", diff: 2, ref: "æ’’æ¯è€³è¨˜ä¸Š 10:1" },
            { q: "è³£é•·å­ååˆ†æ›ç´…è±†æ¹¯çš„æ˜¯èª°ï¼Ÿ", options: ["é›…å„", "ä»¥æƒ", "ç´„ç‘Ÿ", "ç­å‚‘æ˜"], a: 1, cat: "yellow", diff: 2, ref: "å‰µä¸–è¨˜ 25:30-34" },
            { q: "ç¬¬ä¸€ä½æ®‰é“çš„åŸºç£å¾’æ˜¯èª°ï¼Ÿ", options: ["å¸æå", "é›…å„", "å½¼å¾—", "ä¿ç¾…"], a: 0, cat: "yellow", diff: 2, ref: "ä½¿å¾’è¡Œå‚³ 7:59" },
            { q: "è–éˆçš„æœå­å…±æœ‰å¹¾æ¨£ï¼Ÿ", options: ["7æ¨£", "9æ¨£", "12æ¨£", "3æ¨£"], a: 1, cat: "yellow", diff: 2, ref: "åŠ æ‹‰å¤ªæ›¸ 5:22" },
            { q: "åèª¡å¯«åœ¨ä»€éº¼ä¸Šé¢ï¼Ÿ", options: ["ç¾Šçš®å·", "çŸ³ç‰ˆ", "é‡‘ç‰‡", "æœ¨é ­"], a: 1, cat: "yellow", diff: 1, ref: "å‡ºåŸƒåŠè¨˜ 31:18" },
            { q: "å“ªä½å£«å¸«åŠ›å¤§ç„¡çª®ï¼Œå»è¢«é ­é«®å‡ºè³£ï¼Ÿ", options: ["åŸºç”¸", "è€¶å¼—ä»–", "åƒå­«", "åº•æ³¢æ‹‰"], a: 2, cat: "yellow", diff: 1, ref: "å£«å¸«è¨˜ 16:17" },
            { q: "èª°æ˜¯å¤–é‚¦äººçš„ä½¿å¾’ï¼Ÿ", options: ["å½¼å¾—", "ä¿ç¾…", "ç´„ç¿°", "å·´æ‹¿å·´"], a: 1, cat: "yellow", diff: 2, ref: "ç¾…é¦¬æ›¸ 11:13" },
            { q: "èˆŠç´„ä¸­èª°æ´»å¾—æœ€ä¹…ï¼Ÿ", options: ["äºç•¶", "æŒªäº", "ç‘ªåœŸæ’’æ‹‰", "å¡ç‰¹"], a: 2, cat: "yellow", diff: 3, ref: "å‰µä¸–è¨˜ 5:27" },
            { q: "èª°å› å·ç«Šç•¶æ»…ä¹‹ç‰©å°è‡´è‰¾åŸæˆ°å½¹å¤±æ•—ï¼Ÿ", options: ["äºå¹²", "å¯æ‹‰", "å·´è˜­", "åŸºå“ˆè¥¿"], a: 0, cat: "yellow", diff: 3, ref: "ç´„æ›¸äºè¨˜ 7:1" },
            { q: "å¾‹æ³•æ›¸ï¼ˆæ‘©è¥¿äº”ç¶“ï¼‰ä¸åŒ…æ‹¬å“ªä¸€å·ï¼Ÿ", options: ["å‰µä¸–è¨˜", "åˆ©æœªè¨˜", "ç´„æ›¸äºè¨˜", "ç”³å‘½è¨˜"], a: 2, cat: "yellow", diff: 2, ref: "èˆŠç´„åˆ†é¡" },
            { q: "èª°å†’æ­»é€²å»è¦‹ç‹ï¼Œèªªï¼šã€Œæˆ‘è‹¥æ­»å°±æ­»å§ã€ï¼Ÿ", options: ["è·¯å¾—", "æ‹¿ä¿„ç±³", "ä»¥æ–¯å¸–", "å–‡åˆ"], a: 2, cat: "yellow", diff: 2, ref: "ä»¥æ–¯å¸–è¨˜ 4:16" },
            { q: "ä»¥è‰²åˆ—äººéç´„æ—¦æ²³æ™‚ï¼Œèª°è¦å…ˆä¸‹æ°´ï¼Ÿ", options: ["æŠ¬ç´„æ«ƒçš„ç¥­å¸", "çŒ¶å¤§æ”¯æ´¾", "ç´„æ›¸äº", "è»éšŠ"], a: 0, cat: "yellow", diff: 3, ref: "ç´„æ›¸äºè¨˜ 3:13" },
            { q: "åŸºç”¸ç”¨å¤šå°‘äººæ‰“æ•—äº†ç±³ç”¸å¤§è»ï¼Ÿ", options: ["30000äºº", "10000äºº", "300äºº", "12äºº"], a: 2, cat: "yellow", diff: 2, ref: "å£«å¸«è¨˜ 7:7" },
            { q: "èª°åœ¨æ®¿è£¡è¢«ç¥å‘¼å–šä¸‰æ¬¡ï¼Œå›ç­”ã€Œè«‹èªªï¼Œåƒ•äººæ•¬è½ã€ï¼Ÿ", options: ["å¤§è¡›", "æ’’æ¯è€³", "ä»¥åˆ©", "æ‘©è¥¿"], a: 1, cat: "yellow", diff: 2, ref: "æ’’æ¯è€³è¨˜ä¸Š 3:10" },
            { q: "å“ªä½ä½¿å¾’åœ¨é¦¬è€³ä»–å³¶è¢«æ¯’è›‡å’¬å»æ²’äº‹ï¼Ÿ", options: ["å½¼å¾—", "ä¿ç¾…", "ç´„ç¿°", "è…“åŠ›"], a: 1, cat: "yellow", diff: 3, ref: "ä½¿å¾’è¡Œå‚³ 28:3-5" },
            { q: "å·´åˆ¥å¡”äº‹ä»¶è®Šäº‚äº†ä»€éº¼ï¼Ÿ", options: ["ç¨®æ—", "å£éŸ³", "æ–‡å­—", "ä»¥ä¸Šçš†æ˜¯"], a: 1, cat: "yellow", diff: 1, ref: "å‰µä¸–è¨˜ 11:9" },
            { q: "æ‘©è¥¿æ“Šæ‰“ç›¤çŸ³å‡ºæ°´ï¼Œå¾—ç½ªç¥çš„åœ°æ–¹æ˜¯ï¼Ÿ", options: ["æ²’æœ‰å©å’ç›¤çŸ³", "æ“Šæ‰“äº†å…©ä¸‹", "ä¸ä¿¡ç¥", "ç™¼æ€’"], a: 1, cat: "yellow", diff: 3, ref: "æ°‘æ•¸è¨˜ 20:11" },
            { q: "èª°æ¥çºŒä»¥åˆ©äºçš„è·åˆ†ï¼Ÿ", options: ["ä»¥åˆ©æ²™", "åŸºå“ˆè¥¿", "è€¶æˆ¶", "é˜¿æ‘©å¸"], a: 0, cat: "yellow", diff: 2, ref: "åˆ—ç‹ç´€ä¸‹ 2:15" },
            { q: "äºä¼¯æ‹‰ç½•ç»ä»¥æ’’çš„åœ°æ–¹æ˜¯ï¼Ÿ", options: ["æ‘©åˆ©äºå±±", "è¥¿å¥ˆå±±", "äºæ‹‰è‡˜å±±", "å°¼æ³¢å±±"], a: 0, cat: "yellow", diff: 3, ref: "å‰µä¸–è¨˜ 22:2" },
            { q: "èª°æŠŠç´„ç‘Ÿè³£åˆ°åŸƒåŠï¼Ÿ", options: ["ä»¥å¯¦ç‘ªåˆ©äºº", "ä»–çš„å“¥å“¥å€‘", "æ³•è€", "æ³¢æä¹"], a: 1, cat: "yellow", diff: 1, ref: "å‰µä¸–è¨˜ 37:28" },
            { q: "ä¹ƒç¸µå…ƒå¸¥åœ¨å“ªæ¢æ²³æ²æµ´ä¸ƒæ¬¡å¾—é†«æ²»ï¼Ÿ", options: ["å¹¼ç™¼æ‹‰åº•æ²³", "åº•æ ¼é‡Œæ–¯æ²³", "ç´„æ—¦æ²³", "å°¼ç¾…æ²³"], a: 2, cat: "yellow", diff: 2, ref: "åˆ—ç‹ç´€ä¸‹ 5:14" },
            { q: "äº”æ—¬ç¯€è¬›é“ä½¿ä¸‰åƒäººæ‚”æ”¹çš„æ˜¯èª°ï¼Ÿ", options: ["å½¼å¾—", "ä¿ç¾…", "å¸æå", "é›…å„"], a: 0, cat: "yellow", diff: 2, ref: "ä½¿å¾’è¡Œå‚³ 2:41" },
            { q: "èª°æ˜¯è·¯å¾—çš„ç¬¬äºŒä»»ä¸ˆå¤«ï¼Ÿ", options: ["æ³¢é˜¿æ–¯", "ç‘ªå€«", "åŸºé€£", "ä»¥åˆ©ç±³å‹’"], a: 0, cat: "yellow", diff: 2, ref: "è·¯å¾—è¨˜ 4:13" },

            // Green (Peace/Shalom) - New Questions (~10)
            { q: "è€¶ç©Œèªªï¼šã€Œæˆ‘ç•™ä¸‹å¹³å®‰çµ¦ä½ å€‘...ã€é€™å¥è©±å‡ºè‡ªå“ªè£¡ï¼Ÿ", options: ["é¦¬å¤ªç¦éŸ³", "ç´„ç¿°ç¦éŸ³", "è·¯åŠ ç¦éŸ³", "é¦¬å¯ç¦éŸ³"], a: 1, cat: "green", diff: 2, ref: "ç´„ç¿°ç¦éŸ³ 14:27" },
            { q: "ä¿ç¾…èªªï¼šã€Œç¥æ‰€è³œå‡ºäººæ„å¤–çš„å¹³å®‰ã€æœƒä¿å®ˆæˆ‘å€‘çš„å¿ƒæ‡·æ„å¿µã€‚å‡ºè‡ªï¼Ÿ", options: ["è…“ç«‹æ¯”æ›¸", "ç¾…é¦¬æ›¸", "ä»¥å¼—æ‰€æ›¸", "å“¥æ—å¤šå‰æ›¸"], a: 0, cat: "green", diff: 2, ref: "è…“ç«‹æ¯”æ›¸ 4:7" },
            { q: "è€¶ç©Œå‡ºç”Ÿæ™‚ï¼Œå¤©ä½¿é Œè®šèªªï¼šåœ¨åœ°ä¸Šå¹³å®‰æ­¸èˆ‡èª°ï¼Ÿ", options: ["çŒ¶å¤ªäºº", "ç¾…é¦¬äºº", "ä»–æ‰€å–œæ‚…çš„äºº", "æ‰€æœ‰äººé¡"], a: 2, cat: "green", diff: 1, ref: "è·¯åŠ ç¦éŸ³ 2:14" },
            { q: "ä»¥è³½äºé è¨€å½Œè³½äºçš„åç¨±ä¹‹ä¸€æ˜¯ï¼Ÿ", options: ["æˆ°çˆ­ä¹‹ç‹", "å’Œå¹³ä¹‹å›", "å¾‹æ³•ä¹‹ä¸»", "å…ˆçŸ¥ä¹‹é¦–"], a: 1, cat: "green", diff: 1, ref: "ä»¥è³½äºæ›¸ 9:6" },
            { q: "è€¶ç©Œå¾©æ´»å¾Œå‘é–€å¾’é¡¯ç¾ï¼Œç¬¬ä¸€å¥è©±å¸¸èªªï¼Ÿ", options: ["ä½ å€‘å¥½", "é¡˜ä½ å€‘å¹³å®‰", "ç‚ºä»€éº¼ä¸ä¿¡", "æˆ‘æœ‰è‚‰æœ‰éª¨"], a: 1, cat: "green", diff: 1, ref: "ç´„ç¿°ç¦éŸ³ 20:19" },
            { q: "è–éˆçš„æœå­åŒ…å«ä»æ„›ã€å–œæ¨‚å’Œï¼Ÿ", options: ["å¿è€", "æº«æŸ”", "å¹³å®‰", "ç¯€åˆ¶"], a: 2, cat: "green", diff: 1, ref: "åŠ æ‹‰å¤ªæ›¸ 5:22" },
            { q: "ç™»å±±å¯¶è¨“ä¸­èªªï¼šä»€éº¼æ¨£çš„äººæœ‰ç¦äº†ï¼Œå› ç‚ºä»–å€‘å¿…ç¨±ç‚ºç¥çš„å…’å­ï¼Ÿ", options: ["ä½¿äººå’Œç¦çš„äºº", "è™›å¿ƒçš„äºº", "æº«æŸ”çš„äºº", "æ¸…å¿ƒçš„äºº"], a: 0, cat: "green", diff: 2, ref: "é¦¬å¤ªç¦éŸ³ 5:9" },
            { q: "èª°åœ¨ç»ç¥­æ™‚èªªï¼šã€Œè€¶å’Œè¯æ²™é¾ã€ï¼ˆè€¶å’Œè¯è³œå¹³å®‰ï¼‰ï¼Ÿ", options: ["æ‘©è¥¿", "åŸºç”¸", "å¤§è¡›", "äºä¼¯æ‹‰ç½•"], a: 1, cat: "green", diff: 3, ref: "å£«å¸«è¨˜ 6:24" },
            { q: "è©©ç¯‡èªªï¼šæ„›ä½ å¾‹æ³•çš„äººæœ‰å¤§...ï¼Ÿ", options: ["è²¡å¯Œ", "æ™ºæ…§", "å¹³å®‰", "æ¬ŠåŠ›"], a: 2, cat: "green", diff: 2, ref: "è©©ç¯‡ 119:165" },
            { q: "è€¶ç©Œèªªï¼šåœ¨ä¸–ä¸Šä½ å€‘æœ‰è‹¦é›£ï¼Œä½†åœ¨æˆ‘è£¡é¢æœ‰...ï¼Ÿ", options: ["æˆåŠŸ", "å¹³å®‰", "æ¦®è€€", "é•·å£½"], a: 1, cat: "green", diff: 1, ref: "ç´„ç¿°ç¦éŸ³ 16:33" }
        ];

        let state = {
            playerHP: 100,
            maxPlayerHP: 100,
            enemyHP: 100,
            maxEnemyHP: 100,
            score: 0,
            chain: 0,
            level: 1,
            skillMeter: 0,
            skillMax: 5,
            deck: [], 
            activeQuestion: null 
        };

        const enemies = [
            { name: "å¿ƒä¸­çš„æ‡·ç–‘", emoji: "ğŸŒ«ï¸", hp: 30 },
            { name: "æ³•åˆ©è³½äººçš„é…µ", emoji: "ğŸ", hp: 50 },
            { name: "ä¸–ç•Œçš„æƒ…æ…¾", emoji: "ğŸ’", hp: 70 },
            { name: "æ­Œåˆ©äºå·¨äºº", emoji: "ğŸ‘¹", hp: 90 },
            { name: "å¼å«çš„ç…å­", emoji: "ğŸ¦", hp: 120 },
            { name: "ç‘ªé–€çš„èª˜æƒ‘", emoji: "ğŸ’°", hp: 150 },
            { name: "å¤é¾æ’’æ—¦", emoji: "ğŸ²", hp: 200 }
        ];

        const ui = {
            startScreen: document.getElementById('start-screen'),
            gameUi: document.getElementById('game-ui'),
            gameOverScreen: document.getElementById('game-over-screen'),
            gameOverBg: document.getElementById('game-over-bg'),
            cardsContainer: document.getElementById('cards-container'),
            questionModal: document.getElementById('question-modal'),
            qText: document.getElementById('q-text'),
            qRefContainer: document.getElementById('q-ref-container'),
            qRefText: document.getElementById('q-ref-text'),
            optionsContainer: document.getElementById('options-container'),
            hpBar: document.getElementById('player-hp-bar'),
            hpText: document.getElementById('hp-text'),
            enemyHpBar: document.getElementById('enemy-hp-bar'),
            enemyName: document.getElementById('enemy-name'),
            enemySprite: document.getElementById('enemy-sprite'),
            score: document.getElementById('score-display'),
            chain: document.getElementById('chain-display'),
            level: document.getElementById('level-display'),
            qCategory: document.getElementById('q-category'),
            qDifficulty: document.getElementById('q-difficulty'),
            skillIndicator: document.getElementById('skill-indicator'),
            endTitle: document.getElementById('end-title'),
            endScore: document.getElementById('end-score'),
            endEmoji: document.getElementById('end-emoji'),
            timerBar: document.getElementById('timer-bar'),
            submitScoreBtn: document.getElementById('submit-score-btn'),
            playerNameInput: document.getElementById('player-name-input')
        };

        let timerInterval;

        window.startGame = function() {
            ui.startScreen.classList.add('hidden');
            ui.gameUi.classList.remove('hidden');
            ui.gameUi.classList.add('flex');
            resetGame();
            nextLevel();
        }

        window.checkAnswer = function(selectedIndex, btnElement) {
            clearInterval(timerInterval);
            const q = state.activeQuestion;
            const isCorrect = selectedIndex === q.a;
            
            const buttons = ui.optionsContainer.children;
            for(let b of buttons) {
                b.disabled = true;
                b.classList.add('opacity-50', 'cursor-not-allowed');
            }

            if (selectedIndex !== -1 && btnElement) {
                btnElement.classList.remove('opacity-50');
                btnElement.classList.remove('bg-slate-700', 'border-slate-500');
                btnElement.classList.add(isCorrect ? 'bg-green-600' : 'bg-red-600', isCorrect ? 'border-green-400' : 'border-red-400');
            }
            buttons[q.a].classList.remove('opacity-50');
            buttons[q.a].classList.add('ring-4', 'ring-green-400', 'bg-green-600', 'border-green-400');

            ui.qRefContainer.classList.remove('hidden');
            ui.qRefContainer.classList.add('fade-in-up');

            setTimeout(() => {
                ui.questionModal.classList.add('hidden');
                ui.qRefContainer.classList.remove('fade-in-up');
                resolveTurn(isCorrect, q);
            }, 1000);
        };

        function resetGame() {
            state.playerHP = 100;
            state.score = 0;
            state.chain = 0;
            state.level = 0;
            state.skillMeter = 0;
            state.deck = [...fullQuestionBank];
            updateUI();
        }

        function nextLevel() {
            if (state.level >= enemies.length) {
                gameOver(true);
                return;
            }
            const enemyData = enemies[state.level];
            state.level++;
            state.maxEnemyHP = enemyData.hp;
            state.enemyHP = enemyData.hp;
            ui.enemyName.innerText = enemyData.name;
            ui.enemySprite.innerText = enemyData.emoji;
            ui.enemySprite.classList.remove('shake');
            updateUI();
            generateCardOptions();
        }

        function updateUI() {
            const hpPercent = (state.playerHP / state.maxPlayerHP) * 100;
            ui.hpBar.style.width = `${Math.max(0, hpPercent)}%`;
            ui.hpBar.className = `h-full transition-all duration-300 ${state.playerHP < 30 ? 'bg-red-500' : 'bg-gradient-to-r from-green-500 to-emerald-400'}`;
            ui.hpText.innerText = `${Math.max(0, state.playerHP)}/${state.maxPlayerHP}`;

            const enemyHpPercent = (state.enemyHP / state.maxEnemyHP) * 100;
            ui.enemyHpBar.style.width = `${Math.max(0, enemyHpPercent)}%`;

            ui.score.innerText = state.score;
            ui.chain.innerText = state.chain;
            ui.level.innerText = state.level;

            if (state.skillMeter >= state.skillMax) {
                ui.skillIndicator.classList.remove('opacity-0');
                ui.skillIndicator.classList.add('animate-bounce');
                ui.skillIndicator.classList.add('opacity-100');
            } else {
                ui.skillIndicator.classList.add('opacity-0');
                ui.skillIndicator.classList.remove('animate-bounce');
                ui.skillIndicator.classList.remove('opacity-100');
            }
        }

        function generateCardOptions() {
            ui.cardsContainer.innerHTML = '';
            
            if (state.deck.length < 3) {
                state.deck = [...fullQuestionBank]; 
            }

            // Strategy: One of each difficulty (1, 2, 3 stars)
            const diff1 = state.deck.filter(q => q.diff === 1);
            const diff2 = state.deck.filter(q => q.diff === 2);
            const diff3 = state.deck.filter(q => q.diff === 3);

            let handQuestions = [];

            if (diff1.length > 0 && diff2.length > 0 && diff3.length > 0) {
                const q1 = diff1[Math.floor(Math.random() * diff1.length)];
                const q2 = diff2[Math.floor(Math.random() * diff2.length)];
                const q3 = diff3[Math.floor(Math.random() * diff3.length)];
                handQuestions = [q1, q2, q3];
            } else {
                // Fallback if ran out of specific tiers
                let handIndices = [];
                while(handIndices.length < 3) {
                    let r = Math.floor(Math.random() * state.deck.length);
                    if(handIndices.indexOf(r) === -1) handIndices.push(r);
                }
                handQuestions = handIndices.map(i => state.deck[i]);
            }

            // Shuffle display order
            handQuestions.sort(() => Math.random() - 0.5);

            handQuestions.forEach((randomQ) => {
                const card = document.createElement('div');
                card.className = `cursor-pointer w-1/3 h-full rounded-xl flex flex-col items-center justify-center p-3 card-hover border-b-4 transition active:scale-95 select-none relative overflow-hidden`;
                
                let bgClass, textClass, icon, label, shadowClass;
                if (randomQ.cat === 'red') {
                    bgClass = 'bg-gradient-to-br from-red-600 to-red-800 border-red-900';
                    textClass = 'text-red-100';
                    icon = 'â¤ï¸';
                    label = 'æ„›å¿ƒ';
                    shadowClass = 'shadow-red-900/50';
                } else if (randomQ.cat === 'blue') {
                    bgClass = 'bg-gradient-to-br from-blue-600 to-blue-800 border-blue-900';
                    textClass = 'text-blue-100';
                    icon = 'ğŸ’™';
                    label = 'ç›¼æœ›';
                    shadowClass = 'shadow-blue-900/50';
                } else if (randomQ.cat === 'green') {
                    // NEW GREEN STYLE
                    bgClass = 'bg-gradient-to-br from-green-600 to-green-800 border-green-900';
                    textClass = 'text-green-100';
                    icon = 'ğŸŒ¿';
                    label = 'å¹³å®‰';
                    shadowClass = 'shadow-green-900/50';
                } else {
                    bgClass = 'bg-gradient-to-br from-yellow-500 to-yellow-700 border-yellow-800';
                    textClass = 'text-yellow-100';
                    icon = 'ğŸ’›';
                    label = 'ä¿¡å¿ƒ';
                    shadowClass = 'shadow-yellow-900/50';
                }

                card.classList.add(...bgClass.split(' '), 'shadow-lg', shadowClass);
                
                let stars = 'â­'.repeat(randomQ.diff);

                card.innerHTML = `
                    <div class="text-4xl mb-2 drop-shadow-md">${icon}</div>
                    <div class="font-bold text-xl ${textClass} drop-shadow">${label}</div>
                    <div class="text-xs text-white opacity-90 mt-2">${stars}</div>
                    <div class="absolute top-0 right-0 p-1 opacity-20 text-4xl transform translate-x-1 -translate-y-1 rotate-12">${icon}</div>
                `;

                card.onclick = () => {
                    const indexInDeck = state.deck.indexOf(randomQ);
                    if (indexInDeck > -1) {
                        state.deck.splice(indexInDeck, 1);
                    }
                    openQuestion(randomQ);
                };
                ui.cardsContainer.appendChild(card);
            });
        }

        function openQuestion(q) {
            state.activeQuestion = q;
            ui.qText.innerText = q.q;
            
            ui.qRefContainer.classList.add('hidden');
            ui.qRefText.innerText = q.ref || "è–ç¶“";

            if (q.cat === 'red') {
                ui.qCategory.className = "px-4 py-1.5 rounded-full text-sm font-bold text-white bg-red-600 shadow-md";
                ui.qCategory.innerText = "æ„›å¿ƒ";
            } else if (q.cat === 'blue') {
                ui.qCategory.className = "px-4 py-1.5 rounded-full text-sm font-bold text-white bg-blue-600 shadow-md";
                ui.qCategory.innerText = "ç›¼æœ›";
            } else if (q.cat === 'green') {
                ui.qCategory.className = "px-4 py-1.5 rounded-full text-sm font-bold text-white bg-green-600 shadow-md";
                ui.qCategory.innerText = "å¹³å®‰";
            } else {
                ui.qCategory.className = "px-4 py-1.5 rounded-full text-sm font-bold text-white bg-yellow-600 shadow-md";
                ui.qCategory.innerText = "ä¿¡å¿ƒ";
            }
            
            ui.qDifficulty.innerText = `é›£åº¦: ${'â˜…'.repeat(q.diff)}`;

            ui.optionsContainer.innerHTML = '';
            q.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 rounded-xl bg-slate-700 hover:bg-slate-600 border border-slate-500 hover:border-blue-400 transition text-lg font-medium text-gray-100 shadow-md";
                btn.innerText = opt;
                btn.onclick = () => window.checkAnswer(index, btn);
                ui.optionsContainer.appendChild(btn);
            });

            ui.questionModal.classList.remove('hidden');
            startTimer();
        }

        // --- Animation Helper ---
        function playProjectileAnimation(type, startEl, endEl, callback) {
            if (!startEl || !endEl) {
                if (callback) callback();
                return;
            }

            const startRect = startEl.getBoundingClientRect();
            const endRect = endEl.getBoundingClientRect();

            const projectile = document.createElement('div');
            projectile.className = 'projectile';
            
            let emoji = 'ğŸ”®';
            if (type === 'red') emoji = 'ğŸ”¥';
            if (type === 'blue') emoji = 'ğŸ’§';
            if (type === 'yellow') emoji = 'âš¡';
            if (type === 'green') emoji = 'ğŸŒ¿'; // Peace
            if (type === 'dark') emoji = 'ğŸŸ£';
            
            projectile.innerText = emoji;
            
            projectile.style.left = (startRect.left + startRect.width / 2 - 20) + 'px';
            projectile.style.top = (startRect.top + startRect.height / 2 - 20) + 'px';
            
            document.body.appendChild(projectile);

            const animation = projectile.animate([
                { transform: 'translate(0, 0) scale(1)' },
                { transform: `translate(${endRect.left - startRect.left}px, ${endRect.top - startRect.top}px) scale(1.5)` }
            ], {
                duration: 600,
                easing: 'cubic-bezier(0.25, 1, 0.5, 1)'
            });

            animation.onfinish = () => {
                projectile.remove();
                if (callback) callback();
            };
        }

        function resolveTurn(isCorrect, q) {
            const playerEl = document.getElementById('player-sprite');
            const enemyEl = document.getElementById('enemy-sprite');

            if (isCorrect) {
                const attackType = q.cat; 
                
                playProjectileAnimation(attackType, playerEl, enemyEl, () => {
                    let baseDmg = 10;
                    if (q.diff === 2) baseDmg = 25;
                    if (q.diff === 3) baseDmg = 50;

                    const chainBonus = state.chain * 3;
                    const totalDmg = baseDmg + chainBonus;
                    
                    state.enemyHP -= totalDmg;
                    state.score += totalDmg * 10;
                    state.chain++;
                    state.skillMeter++;
                    
                    // Special Healing for Green
                    if (attackType === 'green') {
                        state.playerHP = Math.min(state.maxPlayerHP, state.playerHP + 30);
                        showFloatingText("+30 ğŸŒ¿", "#4ade80", false); // Show on player
                    }

                    if (state.skillMeter >= state.skillMax) {
                        state.playerHP = Math.min(state.maxPlayerHP, state.playerHP + 40);
                        showFloatingText("è–éˆå……æ»¿! +40HP", "#4ade80"); // Show on player (default pos tweaked)
                        state.skillMeter = 0;
                    }

                    showFloatingText(`-${totalDmg}`, "#ff4444", true); // On Enemy
                    animateEnemyDamage();
                    updateUI();
                    checkWinLoss();
                });

            } else {
                playProjectileAnimation('dark', enemyEl, playerEl, () => {
                    const dmg = 15 + (state.level * 2);
                    state.playerHP -= dmg;
                    state.chain = 0;
                    showFloatingText(`å—åˆ°å‚·å®³ -${dmg}`, "#ef4444", false);
                    animatePlayerDamage();
                    updateUI();
                    checkWinLoss();
                });
            }
        }

        function checkWinLoss() {
            if (state.playerHP <= 0) {
                setTimeout(() => gameOver(false), 500);
            } else if (state.enemyHP <= 0) {
                setTimeout(() => nextLevel(), 1000);
            } else {
                generateCardOptions();
            }
        }

        function showFloatingText(text, color, onEnemy = true) {
            const el = document.createElement('div');
            el.innerText = text;
            el.className = 'damage-text';
            el.style.color = color;
            // Adjust position based on target
            if (onEnemy) {
                el.style.left = '50%';
                el.style.top = '30%'; 
            } else {
                // Approximate player position (bottom left area)
                // Since this is fixed pos, we might want to get the player element rect
                const p = document.getElementById('player-sprite').getBoundingClientRect();
                el.style.left = (p.left + 20) + 'px';
                el.style.top = (p.top - 50) + 'px';
                el.style.position = 'fixed';
            }
            // If absolute inside container (default)
            if(onEnemy) {
                 el.style.position = 'absolute';
                 el.style.transform = 'translate(-50%, 0)';
                 document.getElementById('effect-container').appendChild(el);
            } else {
                 document.body.appendChild(el); // Append to body for fixed positioning on player
            }
            
            setTimeout(() => el.remove(), 1200);
        }

        // ... existing animation functions ...
        function animateEnemyDamage() {
            ui.enemySprite.classList.add('shake');
            setTimeout(() => ui.enemySprite.classList.remove('shake'), 500);
        }

        function animatePlayerDamage() {
            ui.gameUi.classList.add('shake');
            setTimeout(() => ui.gameUi.classList.remove('shake'), 500);
        }

        function gameOver(victory) {
            ui.gameUi.classList.add('hidden');
            ui.gameOverScreen.classList.remove('hidden');
            
            const submitBtn = ui.submitScoreBtn;
            ui.playerNameInput.value = "";
            ui.playerNameInput.disabled = false;
            document.getElementById('submit-msg').innerText = "";

            if (!currentUser) {
                 submitBtn.innerText = "é€£ç·šä¸­...";
                 submitBtn.className = "w-full py-2 bg-gray-600 rounded font-bold text-gray-300 cursor-not-allowed";
                 submitBtn.disabled = true;
                 initAuth(); 
            } else {
                 submitBtn.innerText = "ä¸Šå‚³åˆ†æ•¸";
                 submitBtn.className = "w-full py-2 bg-yellow-600 hover:bg-yellow-500 rounded font-bold text-white transition";
                 submitBtn.disabled = false;
            }

            ui.gameOverBg.innerHTML = '';
            const icons = victory ? ['ğŸ‰', 'ğŸ‘‘', 'âœ¨', 'ğŸ†', 'ğŸŒŸ', 'ğŸ›¡ï¸'] : ['ğŸ’¤', 'ğŸ', 'ğŸ•¯ï¸', 'ğŸ•Šï¸', 'ğŸŒ¿', 'ğŸ“–'];
            
            for (let i = 0; i < 15; i++) {
                const icon = icons[Math.floor(Math.random() * icons.length)];
                const div = document.createElement('div');
                div.innerText = icon;
                div.className = 'floating-icon';
                div.style.left = `${Math.random() * 100}%`;
                div.style.animationDuration = `${5 + Math.random() * 10}s`;
                div.style.animationDelay = `${Math.random() * -5}s`;
                div.style.fontSize = `${2 + Math.random() * 2}rem`;
                ui.gameOverBg.appendChild(div);
            }

            if (victory) {
                ui.endTitle.innerText = "æ¦®è€€è¦‹è­‰ï¼";
                ui.endTitle.className = "text-5xl font-bold mb-4 text-yellow-400 drop-shadow-lg";
                ui.endEmoji.innerText = "ğŸ‘‘";
                ui.endScore.innerText = `æœ€çµ‚å¾—åˆ†: ${state.score}\næ„Ÿè¬ä¸»ï¼Œä½ å·²ç©¿æˆ´å…¨å‰¯è»è£æˆ°å‹è©¦ç…‰ï¼`;
            } else {
                ui.endTitle.innerText = "ä¼‘æ¯ä¸‹å†å‡ºç™¼";
                ui.endTitle.className = "text-5xl font-bold mb-4 text-cyan-300 drop-shadow-lg";
                ui.endEmoji.innerText = "ğŸ’¤";
                ui.endScore.innerText = `æœ€çµ‚å¾—åˆ†: ${state.score}\nå¾—åŠ›åœ¨ä¹å¹³éœå®‰ç©©ï¼Œä¸»å¿…æ›´æ–°ä½ çš„åŠ›é‡ï¼`;
            }
        }
    </script>
</body>
</html>
